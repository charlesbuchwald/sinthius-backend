<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>_MissionControl (SINTHIUS)</title>
    <link rel="stylesheet" href="{{static_url('vendor/animate.css/animate.css')}}">
    <link rel="stylesheet" href="{{static_url('vendor/bootstrap/css/bootstrap.min.css')}}">
    <link rel="stylesheet" href="{{static_url('vendor/font-awesome/css/font-awesome.min.css')}}">
    <link rel="stylesheet" href="{{static_url('vendor/ionicons/css/ionicons.min.css')}}">
    <link rel="stylesheet" href="{{static_url('vendor/datatables/datatables.min.css')}}">
    <link rel="stylesheet" href="{{static_url('css/pe-icons/pe-icon-7-stroke.css')}}">
    <link rel="stylesheet" href="{{static_url('css/pe-icons/helper.css')}}">
    <link rel="stylesheet" href="{{static_url('css/stroke-icons/style.css')}}">
    <link rel="stylesheet" href="{{static_url('css/style.css')}}">
</head>
<body>

    <!-- content -->

    <div class="wrapper">
        <nav class="navbar navbar-default navbar-fixed-top">
            <div class="container-fluid">
                <div class="navbar-header">
                    <a class="navbar-brand" href="/a/mc">_MissionControl</a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav navbar-right"></ul>
                </div>
            </div>
        </nav>

        <section class="content">
            <div class="container-fluid">

                <div class="row">
                    <div class="col-lg-12">
                        <div class="view-header">
                            <div class="header-icon">
                                <i class="pe page-header-icon pe-7s-rocket"></i>
                            </div>
                            <div class="header-title">
                                <h3 class="m-b-xs">Mission Control</h3>
                                <small>Dashboard and health information</small>
                            </div>
                        </div>
                        <hr>
                    </div>
                </div>


                <div class="row" id="mission-control">



                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="view-header">
                            <div class="header-icon">
                                <i class="pe page-header-icon pe-7s-gleam"></i>
                            </div>
                            <div class="header-title">
                                <h3 class="m-b-xs">Alive Nodes</h3>
                                <small>List of all alive nodes</small>
                            </div>
                        </div>
                        <hr>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="panel">
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table id="alive_table" class="table display" cellspacing="0" width="100%">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Node</th>
                                                <th>IP</th>
                                                <th>Port</th>
                                                <th>Lock</th>
                                                <th>Health</th>
                                                <th>Uptime</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="view-header">
                            <div class="header-icon">
                                <i class="pe page-header-icon pe-7s-keypad"></i>
                            </div>
                            <div class="header-title">
                                <h3 class="m-b-xs">Nodes</h3>
                                <small>List of all nodes</small>
                            </div>
                        </div>
                        <hr>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <div class="panel">
                            <div class="panel-body">
                                <div class="table-responsive">
                                    <table id="nodes_table" class="table display" cellspacing="0" width="100%">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Hash</th>
                                                <th>IP</th>
                                                <th>Port</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="view-header">
                            <div class="header-icon">
                                <i class="pe page-header-icon pe-7s-tools"></i>
                            </div>
                            <div class="header-title">
                                <h3 class="m-b-xs">Tools</h3>
                                <small>Administrative tools</small>
                            </div>
                        </div>
                        <hr>
                    </div>
                </div>

                <div class="row">
                    <div class="col-xs-6 col-lg-6">
                        <div class="panel panel-c-info">
                            <div class="panel-heading">
                                Update themes on all nodes
                            </div>
                            <div class="panel-body">
                                <p>This action updates all nodes with the new content.</p>
                                <button id="btnUpdate" class="btn btn-info" type="button">
                                    <span class="bold">Update</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-6 col-lg-6">
                        <div class="panel panel-c-info">
                            <div class="panel-heading">
                                Upgrade themes on all nodes
                            </div>
                            <div class="panel-body">
                                <p>This action updates all nodes with the new content and will try to restart.</p>
                                <button id="btnUpgrade" class="btn btn-info" type="button">
                                    <span class="bold">Upgrade</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-6 col-lg-6">
                        <div class="panel panel-c-info">
                            <div class="panel-heading">
                                Update repository themes
                            </div>
                            <div class="panel-body">
                                <p>This action updates the local repository.</p>
                                <button id="btnUpdateRepository" class="btn btn-info" type="button">
                                    <span class="bold">Pull</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="col-xs-6 col-lg-6">
                        <div class="panel panel-c-warning">
                            <div class="panel-heading">
                                Remove all fallen nodes
                            </div>
                            <div class="panel-body">
                                <p>This action will remove all registered fallen nodes.</p>
                                <button id="btnRemoveFallenNodes" class="btn btn-warning" type="button">
                                    <span class="bold">Remove</span>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
        </section>
    </div>

    <!-- scripts -->

    <script src="{{static_url('vendor/pacejs/pace.min.js')}}"></script>
    <script src="{{static_url('vendor/jquery/jquery-2.2.3.min.js')}}"></script>
    <script src="{{static_url('vendor/bootstrap/js/bootstrap.min.js')}}"></script>
    <script src="{{static_url('vendor/datatables/datatables.min.js')}}"></script>
    <script src="{{static_url('js/luna.js')}}"></script>

    <script>
        $(document).ready(function(){

            var _item_value = ''
                + '<div class="col-xs-6 col-md-4">'
                + '    <div class="panel panel-filled">'
                + '        <div class="panel-body">'
                + '            <h2 class="m-b-none server2">{value}</h2>'
                + '            <div class="small">{description}</div>'
                + '        </div>'
                + '    </div>'
                + '</div>';

            var _item_update = ''
                + '<div class="col-xs-12 col-md-12 col-lg-12">'
                + '<div class="panel panel-filled panel-c-info">'
                + '<div class="panel-body">'
                + '<i class="fa fa-clock-o"></i>&nbsp;Updated:&nbsp;<span class="c-white time">{time}</span>'
                + '</div>'
                + '</div>'
                + '</div>';

            var _mission_control = $('#mission-control');

            var _mission_control_items = {
                'uptime': {'key': 'health.details.uptime.uptime.info', 'description': 'Up Time'},
                'health': {'key': 'health.status', 'description': 'Health Status'},
                'publisher': {'key': 'health.details.publisher', 'description': 'Publisher Status'},
                'mission_control': {'key': 'health.details.mission_control', 'description': 'Mission Control Status'},
                'mission_control_channel': {'key': 'health.details.mission_control_channel', 'description': 'Mission Control Channel'},
                'alive_nodes': {'key': 'health.details.scope.nodes.alive', 'description': 'Alive Nodes'},
                'fallen_nodes': {'key': 'health.details.scope.nodes.fallen', 'description': 'Fallen Nodes'},
                'lock': {'key': 'lock', 'description': 'Lock Status'},
                'hash': {'key': 'hash', 'description': 'Node Hash'},
                'node': {'key': 'node', 'description': 'Node Name'},
                'ip': {'key': 'ip', 'description': 'IP Address'},
                'port': {'key': 'port', 'description': 'Port Number'}
            };

            function _get(obj, path){try{return eval("obj."+path);} catch(e) {return undefined;}}

            var mission_control_updater = function(){
                try {
                    $.getJSON('/api/node/health', {}, function(r){
                        _mission_control.empty();


                        var key, value, content, data = r.response;
                        for(key in _mission_control_items){
                            value = _mission_control_items[key];
                            content = _get(data, value.key);
                            if(key.search(/(fallen|alive)_nodes/i) > -1) {
                                content = content.length;
                            }else if(key.search(/uptime/i) > -1) {
                                content = format('{days}d {hours}h {minutes}m {seconds}s', content);
                            }else if(key.search(/hash/i) > -1) {
                                content = content.substring(0, 8);
                            }
                            _mission_control.append(format(_item_value, {
                                'value': content,
                                'description': value.description
                            }));
                        }

                        _mission_control.append(format(_item_update, {'time': new Date().toISOString()}));

                    });
                } catch (e) {}
                setTimeout(mission_control_updater, 5000);
            };

            mission_control_updater();

            var alive_table = $('#alive_table').DataTable({
                'ajax': {
                    'url': '/api/nodes/alive/health',
                    'dataSrc': 'response.alive.nodes'
                },
                'columns': [
                    {'data': 'name'},
                    {'data': 'node'},
                    {'data': 'ip'},
                    {'data': 'port'},
                    {'data': 'lock'},
                    {'data': 'health.status'},
                    {
                        'data': 'health.details.uptime.uptime.info',
                        'render': function(data, type, full, meta){
                            try {
                                return format('{days}d {hours}h {minutes}m {seconds}s', data);
                            }catch (e){
                                return '-';
                            }

                        }
                    }
                ]
            });

            setInterval(function(){alive_table.ajax.reload()}, 10000);

            var nodes_table = $('#nodes_table').DataTable({
                'ajax': {
                    'url': '/api/nodes/cache',
                    'dataSrc': 'response'
                },
                'columns': [
                    {'data': 'name'},
                    {'data': 'hash'},
                    {'data': 'ip'},
                    {'data': 'port'}
                ]
            });

            setInterval(function(){nodes_table.ajax.reload()}, 10000);

            $('#btnUpdate').on('click', function(event){
                event.preventDefault();
                $.getJSON('/a/mc/api/update', {}, function(r){});
            });

            $('#btnUpgrade').on('click', function(event){
                event.preventDefault();
                $.getJSON('/a/mc/api/upgrade', {}, function(r){});
            });

            $('#btnUpdateRepository').on('click', function(event){
                event.preventDefault();
                $.getJSON('/a/mc/api/git/pull', {}, function(r){});
            });

            $('#btnRemoveFallenNodes').on('click', function(event){
                event.preventDefault();
                $.getJSON('/a/mc/api/remove/fallen', {}, function(r){});
            });

        });
    </script>

</body>
</html>
